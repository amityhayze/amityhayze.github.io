<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Amity Hayze — Music</title>
  <style>
    :root{
      --neon: #00f0ff;
      --muted: #9beef7;
      --bg-dark: #000;
      --hazy-pink: rgba(255,107,205,0.25);
      --hazy-pink-light: rgba(255,107,205,0.35);

      /* palette (updated by presets) */
      --viz-pink: 255,107,205;
      --viz-cyan: 0,240,255;
      --viz-strength: 1;
    }

    /* ===== page baseline (keeps your look) ===== */
    html,body{height:100%;margin:0;background:radial-gradient(circle at center,#0a0a0f,#050509,#000);font-family:"Courier New",monospace;color:var(--neon);-webkit-font-smoothing:antialiased}
    body{overflow-x:hidden;text-align:center;display:flex;flex-direction:column;align-items:center;position:relative;padding-bottom:40px}

    h1{margin-top:1.5rem;text-shadow:0 0 8px #ff00ff,0 0 20px #00fff6;font-size:1.8rem;z-index:3;color:var(--neon)}

    /* pulse background (reactive via JS setting --pulse) */
    .pulse-bg{
      position:fixed;inset:0;z-index:0;
      background: radial-gradient(circle at center, rgba(255,0,255,0.02), rgba(0,255,255,0.04));
      pointer-events:none;
      transition:opacity .18s linear;
      mix-blend-mode:screen;
      opacity:0.9;
    }

    /* preset menu */
    .preset-menu{
      position:fixed;top:1rem;right:1rem;z-index:6;display:flex;flex-direction:column;gap:.5rem;
      background:rgba(10,10,20,0.75);border:2px solid #ff2efc;border-radius:12px;padding:1rem;box-shadow:0 0 12px #ff2efc;
    }
    .preset-menu button{
      background:transparent;border:1px solid #ffb7ff;border-radius:6px;color:#ffb7ff;padding:.4rem .8rem;cursor:pointer;font-family:inherit;transition:all .18s;
    }
    .preset-menu button:disabled{opacity:.45;cursor:not-allowed}
    .preset-menu button:hover:not(:disabled){background:#ffb7ff;color:#0a0a0a;box-shadow:0 0 10px #ffb7ff}

    /* play / stop */
    .controls-top{z-index:5; margin-top:12px; display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap}
    .btn{
      --pad:12px 20px;
      display:inline-block;padding:var(--pad);border-radius:10px;background:linear-gradient(180deg,rgba(0,255,255,0.06),rgba(0,255,255,0.02));
      color:var(--neon);text-decoration:none;font-weight:700;border:1px solid rgba(0,255,255,0.18);box-shadow:0 0 18px rgba(0,240,255,0.06);cursor:pointer;transition:all .18s;text-transform:uppercase;letter-spacing:1px;
    }
    .btn-pink{
      background:linear-gradient(180deg,var(--hazy-pink),rgba(255,107,205,0.1));
      border:1px solid rgba(255,107,205,0.4); color:#e813f0; box-shadow:0 0 20px var(--hazy-pink);
    }
    .btn:disabled{opacity:.5;cursor:not-allowed}

    /* TV / visual area */
    .wrap{max-width:980px;width:100%;padding:22px;z-index:2}
    .panel{background:rgba(0,0,0,0.7);border-radius:12px;padding:20px;border:1px solid rgba(0,255,255,0.06);box-shadow:0 20px 60px rgba(0,240,255,0.03);position:relative;overflow:visible}
    .tv-wrap{display:flex;gap:18px;align-items:flex-start;flex-wrap:wrap;justify-content:center}
    .tv{width:min(760px,94%);aspect-ratio:16/9;border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,0.04);background:#000;margin:10px auto;position:relative;z-index:3}
    /* canvas used for viz */
    #vizCanvas{display:block;width:100%;height:100%}

    /* control column */
    .controls{min-width:240px;max-width:260px;display:flex;flex-direction:column;gap:10px;align-items:stretch}
    .knob label{display:block;margin-bottom:6px;color:var(--muted);font-size:13px}
    .slider{width:100%}
    input[type="range"]{appearance:none;height:8px;background:rgba(255,255,255,0.04);border-radius:8px}
    input[type="range"]::-webkit-slider-thumb{appearance:none;width:14px;height:14px;border-radius:50%;background:#fff;box-shadow:0 0 8px rgba(0,0,0,0.6)}
    .play-controls{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}

    /* embeds area (keeps your look) */
    .embeds{margin-top:18px;padding:18px;z-index:2;width:90%;max-width:980px}
    .embed-card{background:rgba(255,255,255,0.02);border-radius:10px;padding:12px;border:1px solid rgba(0,255,255,0.04);margin-bottom:12px}
    .player-embed{width:100%;height:360px;border:0;border-radius:8px;display:block;overflow:hidden}
    @media (max-width:680px){.player-embed{height:260px}.controls{width:100%;min-width:auto;max-width:none}}

    footer{margin-top:12px;color:var(--muted);font-size:13px;text-align:center}

    /* scanlines overlay drawn by canvas as well; keep reduced motion support */
    @media (prefers-reduced-motion:reduce){*{transition:none!important;animation:none!important}}
  </style>
</head>
<body>
  <div class="pulse-bg" id="pulseBg" aria-hidden="true"></div>

  <h1>Amity Hayze — Cascade Canyon</h1>

  <!-- preset menu visible by default -->
  <div class="preset-menu" aria-hidden="false">
    <button id="presetCRT" onclick="setPreset('crt')">CRT</button>
    <button id="presetVHS" onclick="setPreset('vhs')">VHS</button>
    <button id="presetNeon" onclick="setPreset('neon')">Neon</button>
  </div>

  <div class="controls-top" role="region" aria-label="Playback controls">
    <button id="playBtn" class="btn btn-pink">▶ Play</button>
    <button id="stopBtn" class="btn" disabled>■ Stop</button>
    <a class="btn" href="index.html" style="text-decoration:none">Back</a>
  </div>

  <div class="wrap">
    <div class="panel" role="main">
      <header style="text-align:center;margin-bottom:12px">
        <div style="display:flex;justify-content:center;gap:10px;align-items:center">
          <div class="title" data-text="Amity Hayze" style="font-size:18px;color:var(--neon)">Vintage Oscilloscope Sphere</div>
        </div>
        <div class="subtitle" style="color:var(--muted);font-size:13px;margin-top:6px">Centered, reactive, and preset-driven — click Play to start.</div>
      </header>

      <div class="tv-wrap" style="justify-content:center">
        <div class="tv" role="region" aria-label="Visualizer TV">
          <canvas id="vizCanvas" aria-hidden="false"></canvas>
        </div>

        <div class="controls" role="region" aria-label="Visualizer controls">
          <div class="knob">
            <label for="sensitivity" style="color:var(--muted)">Sensitivity</label>
            <input id="sensitivity" class="slider" type="range" min="0.4" max="3" step="0.05" value="1.2">
          </div>

          <div class="knob">
            <label for="strings" style="color:var(--muted)">Strings</label>
            <input id="strings" class="slider" type="range" min="6" max="80" step="1" value="34">
          </div>

          <div class="knob">
            <label for="glow" style="color:var(--muted)">Glow</label>
            <input id="glow" class="slider" type="range" min="0" max="2" step="0.05" value="0.9">
          </div>

          <div class="play-controls">
            <button id="presetApply" class="btn" disabled>Presets Active After Play</button>
          </div>
        </div>
      </div>

      <!-- Hidden audio element (local file) -->
      <audio id="sourceAudio" src="Cascade Canyon.mp3" crossorigin="anonymous"></audio>

      <!-- EMBEDS (untouched content kept) -->
      <div class="embeds">
        <div class="embed-card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div style="font-weight:700;color:var(--neon)">Spotify — Full Artist</div>
            <div style="font-size:12px;color:var(--muted)">Listen across platforms</div>
          </div>
          <iframe class="player-embed" src="https://open.spotify.com/embed/artist/5NMNo5sQFABJdY3jHH53wf?utm_source=generator&theme=0" allow="autoplay; clipboard-write; encrypted-media" loading="lazy" title="Spotify — Amity Hayze"></iframe>
        </div>

        <div class="embed-card">
          <div style="font-weight:700;color:var(--neon);margin-bottom:8px">YouTube — Videos</div>
          <iframe class="player-embed" src="https://www.youtube.com/embed/g4fDgnUd2RQ?si=TEZu2KV-p3Os_VX4" allow="autoplay; encrypted-media; picture-in-picture" loading="lazy" title="YouTube video — Amity Hayze"></iframe>
        </div>

        <div class="embed-card">
          <div style="font-weight:700;color:var(--neon);margin-bottom:8px">Bandcamp / Apple / Other</div>
          <iframe style="border: 0; width: 100%; height: 120px;" src="https://bandcamp.com/EmbeddedPlayer/track=2057022344/size=large/bgcol=ffffff/linkcol=0687f5/tracklist=false/artwork=small/transparent=true/" seamless><a href="https://amityhayze.bandcamp.com/track/gone-is-the-time-2">Gone is the Time by Amity Hayze</a></iframe>
        </div>

        <div class="embed-card">
          <div style="font-weight:700;color:var(--neon);margin-bottom:8px">Featured Playlists</div>
          <iframe class="player-embed" src="https://open.spotify.com/embed/playlist/08i9sjghPv0YOJgvwrGypr?utm_source=generator" allow="autoplay; clipboard-write; encrypted-media" loading="lazy" title="Playlist 1"></iframe>
          <iframe class="player-embed" src="https://open.spotify.com/embed/playlist/0Lp9po0968hO1xUakltvku?utm_source=generator" allow="autoplay; clipboard-write; encrypted-media" loading="lazy" title="Playlist 2"></iframe>
        </div>
      </div>

      <footer><div style="color:var(--muted)">© Amity Hayze — transmissions & static</div></footer>
    </div>
  </div>

<script>
/* Visualizer: cleaned/working version based on your earlier draft.
   - Use Play to initialize AudioContext and start animation.
   - Presets change CSS variables to alter color & feel.
*/

(function(){
  // DOM
  const audio = document.getElementById('sourceAudio');
  const playBtn = document.getElementById('playBtn');
  const stopBtn = document.getElementById('stopBtn');
  const viz = document.getElementById('vizCanvas');
  const ctx = viz.getContext('2d', { alpha: true });

  const sensitivityEl = document.getElementById('sensitivity');
  const stringsEl = document.getElementById('strings');
  const glowEl = document.getElementById('glow');

  const pulseBg = document.getElementById('pulseBg');
  const presetApplyBtn = document.getElementById('presetApply');
  const presetButtons = {
    crt: document.getElementById('presetCRT'),
    vhs: document.getElementById('presetVHS'),
    neon: document.getElementById('presetNeon')
  };

  // audio / analyser
  let audioCtx = null, analyser = null, sourceNode = null;
  let dataArray = null, bufferLength = 0;

  // visual state
  let raf = null;
  let width = 0, height = 0, dpr = Math.max(1, window.devicePixelRatio || 1);
  const settings = {
    sensitivity: parseFloat(sensitivityEl.value),
    strings: parseInt(stringsEl.value, 10),
    glow: parseFloat(glowEl.value)
  };

  // init canvas size to tv area
  function resizeCanvas(){
    const rect = viz.getBoundingClientRect();
    width = Math.max(320, Math.floor(rect.width));
    height = Math.max(180, Math.floor(rect.height));
    viz.width = width * dpr;
    viz.height = height * dpr;
    viz.style.width = width + 'px';
    viz.style.height = height + 'px';
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  window.addEventListener('resize', resizeCanvas);
  // ensure resize after layout
  setTimeout(resizeCanvas, 80);

  // create audio context on user gesture
  function initAudio(){
    if (audioCtx) return;
    try {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 2048;
      bufferLength = analyser.frequencyBinCount;
      dataArray = new Uint8Array(bufferLength);

      sourceNode = audioCtx.createMediaElementSource(audio);
      sourceNode.connect(analyser);
      analyser.connect(audioCtx.destination);
    } catch (err) {
      console.warn('WebAudio error:', err);
    }
  }

  // amplitude (RMS) helper
  function getAmplitude(){
    if (!analyser) return 0;
    analyser.getByteTimeDomainData(dataArray);
    let sum = 0;
    for (let i=0;i<bufferLength;i++){
      const v = (dataArray[i] - 128) / 128;
      sum += v*v;
    }
    const rms = Math.sqrt(sum / bufferLength);
    return Math.min(1, rms * 1.8);
  }

  // draw sphere of strings
  function draw(time){
    ctx.clearRect(0,0,width,height);

    // base fill
    ctx.fillStyle = 'rgba(0,0,0,0.38)';
    ctx.fillRect(0,0,width,height);

    const cx = width/2, cy = height/2;
    const baseR = Math.min(width, height) * 0.32;
    const amp = getAmplitude() * settings.sensitivity;

    // glow radial from CSS vars (mix of pink/cyan)
    const pv = getComputedStyle(document.documentElement).getPropertyValue('--viz-pink').trim().split(',').map(x=>parseInt(x));
    const cv = getComputedStyle(document.documentElement).getPropertyValue('--viz-cyan').trim().split(',').map(x=>parseInt(x));
    // fallback if not set
    const pink = (pv.length===3) ? pv : [255,107,205];
    const cyan = (cv.length===3) ? cv : [0,240,255];

    // draw halo
    const glow = settings.glow * (0.6 + amp * 0.9);
    const g = ctx.createRadialGradient(cx,cy, baseR*0.2, cx,cy, baseR*1.8);
    g.addColorStop(0, `rgba(${pink[0]},${pink[1]},${pink[2]},${0.06 * glow})`);
    g.addColorStop(0.6, `rgba(${cyan[0]},${cyan[1]},${cyan[2]},${0.025 * glow})`);
    g.addColorStop(1, 'rgba(0,0,0,0)');
    ctx.fillStyle = g;
    ctx.beginPath(); ctx.arc(cx,cy, baseR*1.6,0,Math.PI*2); ctx.fill();

    // string rings
    const rings = Math.max(3, Math.round(settings.strings / 6));
    const perRing = Math.round(settings.strings / rings);

    for (let r=0; r<rings; r++){
      const lat = (r / (rings-1)) * Math.PI - Math.PI/2;
      const ringRadius = Math.cos(lat) * baseR;
      const z = Math.sin(lat);
      const perspective = (z + 1)/2 * 0.9 + 0.1;
      const alphaBase = 0.12 + perspective * 0.6;

      for (let s=0; s<perRing; s++){
        const t = s / perRing;
        const theta = t * Math.PI * 2;

        // map theta to freq bin
        let freqVal = 0;
        if (analyser && dataArray){
          const idx = Math.floor((t * bufferLength * 0.7)) % bufferLength;
          freqVal = Math.abs(dataArray[idx] - 128) / 128 * amp;
        }

        const wobble = Math.sin(time*0.002 + r*0.6 + s*0.12) * 0.8;
        const px = cx + Math.cos(theta) * (ringRadius + freqVal * baseR * 0.28 + wobble*4);
        const py = cy + Math.sin(theta) * (ringRadius*0.5 + freqVal * baseR * 0.18 + wobble*2) * (0.9 - Math.abs(z)*0.3);

        const mix = 0.5 + 0.5 * Math.sin(theta + time*0.0008 + r*0.25);
        const rC = Math.round(cyan[0] * (1-mix) + pink[0] * mix);
        const gC = Math.round(cyan[1] * (1-mix) + pink[1] * mix);
        const bC = Math.round(cyan[2] * (1-mix) + pink[2] * mix);
        ctx.fillStyle = `rgba(${rC},${gC},${bC},${alphaBase * (0.6 + freqVal*1.4)})`;

        const size = 0.9 + perspective*2 + freqVal*4;
        ctx.beginPath(); ctx.arc(px,py,size,0,Math.PI*2); ctx.fill();

        // small highlight
        ctx.beginPath(); ctx.fillStyle = `rgba(255,255,255,${0.02 + freqVal*0.08})`; ctx.arc(px,py,size*0.35,0,Math.PI*2); ctx.fill();
      }
    }

    // subtle scanlines
    ctx.fillStyle = 'rgba(255,255,255,0.008)';
    for (let y=0;y<height;y+=3){
      ctx.fillRect(0,y,width,1);
    }

    // reactive pulse background intensity
    const pulseStrength = 0.06 + amp * 0.24;
    pulseBg.style.opacity = 0.35 + pulseStrength;
    raf = requestAnimationFrame(draw);
  }

  // UI wiring
  sensitivityEl.addEventListener('input', ()=> settings.sensitivity = parseFloat(sensitivityEl.value));
  stringsEl.addEventListener('input', ()=> settings.strings = parseInt(stringsEl.value,10));
  glowEl.addEventListener('input', ()=> settings.glow = parseFloat(glowEl.value));

  // presets - just change CSS vars
  function setPreset(p){
    // only allow presets after play
    if (!audioCtx) return;
    if (p === 'crt'){
      document.documentElement.style.setProperty('--viz-pink','220,255,200');
      document.documentElement.style.setProperty('--viz-cyan','80,220,120');
      document.documentElement.style.setProperty('--hazy-pink','rgba(120,255,180,0.10)');
      document.documentElement.style.setProperty('--hazy-pink-light','rgba(120,255,180,0.18)');
      document.documentElement.style.setProperty('--viz-strength','0.8');
    } else if (p === 'vhs'){
      document.documentElement.style.setProperty('--viz-pink','255,120,160');
      document.documentElement.style.setProperty('--viz-cyan','150,160,255');
      document.documentElement.style.setProperty('--hazy-pink','rgba(255,120,160,0.16)');
      document.documentElement.style.setProperty('--hazy-pink-light','rgba(255,120,160,0.28)');
      document.documentElement.style.setProperty('--viz-strength','1.05');
    } else { // neon
      document.documentElement.style.setProperty('--viz-pink','255,107,205');
      document.documentElement.style.setProperty('--viz-cyan','0,240,255');
      document.documentElement.style.setProperty('--hazy-pink','rgba(255,107,205,0.25)');
      document.documentElement.style.setProperty('--hazy-pink-light','rgba(255,107,205,0.35)');
      document.documentElement.style.setProperty('--viz-strength','1.2');
    }
  }

  // enable/disable preset buttons depending on audio state
  function setControlsEnabled(enabled){
    Object.values(presetButtons).forEach(b => b.disabled = !enabled);
    presetApplyBtn.disabled = !enabled;
    stopBtn.disabled = !enabled;
  }

  // Play button
  playBtn.addEventListener('click', async ()=>{
    initAudio();
    // resume AudioContext if suspended
    if (audioCtx && audioCtx.state === 'suspended') {
      await audioCtx.resume();
    }
    try {
      // some browsers block play() until user gesture; this click is a gesture
      await audio.play();
    } catch (err) {
      console.warn('play() failed', err);
    }
    // start visual loop
    cancelAnimationFrame(raf);
    resizeCanvas();
    raf = requestAnimationFrame(draw);
    // enable controls now that audio is running
    setControlsEnabled(true);
    playBtn.textContent = 'Playing';
    playBtn.disabled = true;
    stopBtn.disabled = false;
  });

  stopBtn.addEventListener('click', ()=>{
    audio.pause();
    audio.currentTime = 0;
    cancelAnimationFrame(raf);
    ctx.clearRect(0,0,viz.width,viz.height);
    setControlsEnabled(false);
    playBtn.textContent = '▶ Play';
    playBtn.disabled = false;
    stopBtn.disabled = true;
  });

  // default controls are disabled until Play (presets require audioCtx)
  setControlsEnabled(false);

  // start with neon preset but buttons disabled until play
  setPreset('neon');

  // accessibility: stop rendering on page hide
  document.addEventListener('visibilitychange', ()=>{
    if (document.hidden) cancelAnimationFrame(raf);
    else if (audioCtx && !raf && !playBtn.disabled) raf = requestAnimationFrame(draw);
  });

  // resize once more after load to ensure correct size
  window.addEventListener('load', ()=> setTimeout(resizeCanvas, 60));
  // allow click on preset to set if audio already started
  window.setPreset = setPreset;

})();
</script>
</body>
</html>

